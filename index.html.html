<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minha Rotina — App</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--ok:#10b981}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:linear-gradient(180deg,#071021, #061323);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .app{width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    form{display:flex;gap:8px;flex-wrap:wrap}
    input,select,textarea,button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit}
    button{background:var(--accent);border:none;color:#042029;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .list{max-height:60vh;overflow:auto;margin-top:12px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .item .left{display:flex;gap:10px;align-items:center}
    .time{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:6px}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    footer{margin-top:10px;color:var(--muted);font-size:13px}
    /* mini calendar */
    .calendar{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
    .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-day{padding:8px;border-radius:6px;text-align:center;cursor:pointer;border:1px solid transparent}
    .cal-day:hover{border-color:rgba(255,255,255,0.04)}
    .cal-day.today{box-shadow:0 0 0 2px rgba(6,182,212,0.12)}
    .cal-day.selected{background:rgba(6,182,212,0.12);font-weight:700}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Minha Rotina</h1>
      <div class="small">Salvo localmente no seu navegador • Export/Import disponível</div>
    </header>

    <div class="grid">
      <section class="card">
        <form id="taskForm">
          <input id="title" placeholder="Nome da tarefa (ex.: Estudar Português)" required style="flex:1"/>
          <input id="time" type="time" />
          <select id="repeat">
            <option value="daily">Diário</option>
            <option value="weekdays">Dias úteis</option>
            <option value="once">Uma vez</option>
          </select>
          <!-- Date chooser: agora visível sempre para facilitar -->
          <input id="date" type="date" />
          <textarea id="note" placeholder="Notas (opcional)" rows="2"></textarea>
          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
            <button type="submit">Adicionar tarefa</button>
            <button id="clearDone" type="button" class="ghost">Limpar concluídas</button>
            <button id="exportBtn" type="button" class="ghost">Exportar JSON</button>
            <button id="importBtn" type="button" class="ghost">Importar JSON</button>
            <input id="fileInput" type="file" accept="application/json" style="display:none" />
          </div>
        </form>

        <div class="list" id="tasksList" aria-live="polite"></div>
        <footer>Permissão de notificações pode ser solicitada para lembretes.</footer>
      </section>

      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Visão rápida</strong>
          <div class="small" id="todayDate"></div>
        </div>
        <div id="summary" class="small"></div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0" />

        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">
          <button id="todayView" class="ghost">Ver Hoje</button>
          <button id="allView" class="ghost">Ver Todas</button>
          <button id="requestPerm" class="ghost">Ativar Notificações</button>
        </div>

        <div class="calendar" id="miniCalendarWrap">
          <div class="cal-header">
            <button id="prevMonth" class="ghost">‹</button>
            <div id="calTitle" style="font-weight:700"></div>
            <button id="nextMonth" class="ghost">›</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="selectToday" class="ghost">Selecionar hoje</button>
            <button id="clearDate" class="ghost">Limpar seleção</button>
          </div>
        </div>

      </aside>
    </div>
  </div>

  <script>
    // Simple routine manager using localStorage
    const STORAGE_KEY = 'minha_rotina_v1'
    let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')

    const form = document.getElementById('taskForm')
    const list = document.getElementById('tasksList')
    const titleIn = document.getElementById('title')
    const timeIn = document.getElementById('time')
    const repeatIn = document.getElementById('repeat')
    const dateIn = document.getElementById('date')
    const noteIn = document.getElementById('note')
    const todayDate = document.getElementById('todayDate')
    const summary = document.getElementById('summary')

    const exportBtn = document.getElementById('exportBtn')
    const importBtn = document.getElementById('importBtn')
    const fileInput = document.getElementById('fileInput')
    const clearDone = document.getElementById('clearDone')

    // mini calendar elements
    const calTitle = document.getElementById('calTitle')
    const calGrid = document.getElementById('calGrid')
    const prevMonth = document.getElementById('prevMonth')
    const nextMonth = document.getElementById('nextMonth')
    const selectToday = document.getElementById('selectToday')
    const clearDate = document.getElementById('clearDate')

    let calDate = new Date()
    let selectedDate = null

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); render() }

    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6) }

    function render(filter='all'){
      list.innerHTML = ''
      const today = new Date();
      todayDate.textContent = today.toLocaleDateString()

      let visible = tasks
      if(filter === 'today'){
        visible = tasks.filter(t => {
          if(t.repeat === 'daily') return true
          if(t.repeat === 'weekdays'){ const d = new Date().getDay(); return d>0 && d<6 }
          if(t.repeat === 'once'){ return t.date === today.toISOString().slice(0,10) }
          return true
        })
      } else if(filter === 'selected' && selectedDate){
        visible = tasks.filter(t => {
          if(t.repeat === 'daily') return true
          if(t.repeat === 'weekdays'){ const d = new Date(selectedDate).getDay(); return d>0 && d<6 }
          if(t.repeat === 'once') return t.date === selectedDate
          return true
        })
      }

      visible.sort((a,b)=> (a.time||'') > (b.time||'') ? 1 : -1)

      visible.forEach(t=>{
        const el = document.createElement('div'); el.className='item'
        const left = document.createElement('div'); left.className='left'
        const time = document.createElement('div'); time.className='time'; time.textContent = t.time || '—'
        const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:600">${escapeHtml(t.title)}</div><div class="small">${escapeHtml(t.note||'')} ${t.repeat==='once' && t.date? '• '+t.date : ''}</div>`
        left.appendChild(time); left.appendChild(meta)
        const controls = document.createElement('div'); controls.className='controls'
        const doneBtn = document.createElement('button'); doneBtn.textContent = t.done? 'Desmarcar' : 'Concluir'
        doneBtn.onclick = ()=>{ t.done = !t.done; save() }
        const delBtn = document.createElement('button'); delBtn.textContent='Excluir'; delBtn.className='ghost'; delBtn.onclick = ()=>{ tasks = tasks.filter(x=>x.id!==t.id); save() }
        controls.appendChild(doneBtn); controls.appendChild(delBtn)
        if(t.done){ el.style.opacity = 0.6; el.style.textDecoration='line-through' }
        el.appendChild(left); el.appendChild(controls)
        list.appendChild(el)
      })

      const total = tasks.length
      const done = tasks.filter(t=>t.done).length
      summary.innerHTML = `<div>Total tarefas: <strong>${total}</strong></div><div>Concluídas: <strong>${done}</strong></div>`
    }

    form.addEventListener('submit', e=>{
      e.preventDefault()
      const t = { id: uid(), title: titleIn.value.trim(), time: timeIn.value, repeat: repeatIn.value, date: dateIn.value || null, note: noteIn.value.trim(), done:false }
      tasks.push(t); save()
      form.reset()
    })

    repeatIn.addEventListener('change', ()=>{
      if(repeatIn.value === 'once') dateIn.style.display = 'inline-block'
    })

    document.getElementById('todayView').addEventListener('click', ()=> render('today'))
    document.getElementById('allView').addEventListener('click', ()=> render('all'))
    document.getElementById('requestPerm').addEventListener('click', async ()=>{
      if(!('Notification' in window)) return alert('Notificações não são suportadas neste navegador.')
      const r = await Notification.requestPermission()
      alert('Permissão: '+r)
    })

    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='rotina_export.json'; a.click(); URL.revokeObjectURL(url)
    })

    importBtn.addEventListener('click', ()=> fileInput.click())
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files[0]
      if(!f) return
      const reader = new FileReader()
      reader.onload = ()=>{
        try{ const imported = JSON.parse(reader.result); if(Array.isArray(imported)){ tasks = imported; save(); alert('Importado com sucesso') } else alert('Arquivo inválido') }
        catch(err){ alert('Erro ao importar: '+err.message) }
      }
      reader.readAsText(f)
    })

    clearDone.addEventListener('click', ()=>{ tasks = tasks.filter(t=>!t.done); save() })

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // optional: simple reminders checker (runs while page is open)
    setInterval(()=>{
      const now = new Date(); const cur = now.toTimeString().slice(0,5)
      tasks.forEach(t=>{
        if(t.time === cur && !t._notified){
          if(window.Notification && Notification.permission === 'granted'){
            new Notification('Lembrete: '+t.title, {body: t.note || ''})
          }
          t._notified = true
        }
        if(t.time && t.time !== cur) t._notified = false
      })
    }, 1000*30)

    // --- mini calendar functions ---
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1) }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0) }

    function renderCalendar(){
      calGrid.innerHTML = ''
      const start = startOfMonth(calDate)
      const end = endOfMonth(calDate)
      const firstWeekday = start.getDay() // 0=Sun
      const daysInMonth = end.getDate()

      const title = calDate.toLocaleString(undefined, {month:'long', year:'numeric'})
      calTitle.textContent = title.charAt(0).toUpperCase() + title.slice(1)

      // week day headers
      const weekNames = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb']
      weekNames.forEach(n=>{
        const el = document.createElement('div'); el.className='cal-day'; el.style.fontWeight='700'; el.style.cursor='default'; el.textContent = n; calGrid.appendChild(el)
      })

      // empty slots
      for(let i=0;i<firstWeekday;i++){ const empty = document.createElement('div'); empty.className='cal-day'; empty.textContent=''; calGrid.appendChild(empty) }

      for(let d=1; d<=daysInMonth; d++){
        const el = document.createElement('div'); el.className='cal-day'; el.textContent = d
        const y = calDate.getFullYear(), m = calDate.getMonth()
        const iso = new Date(y,m,d).toISOString().slice(0,10)
        el.dataset.iso = iso
        if(iso === new Date().toISOString().slice(0,10)) el.classList.add('today')
        if(selectedDate === iso) el.classList.add('selected')
        el.addEventListener('click', ()=>{
          selectedDate = iso
          dateIn.value = iso
          repeatIn.value = 'once'
          renderCalendar(); render('selected')
        })
        calGrid.appendChild(el)
      }
    }

    prevMonth.addEventListener('click', ()=>{ calDate = new Date(calDate.getFullYear(), calDate.getMonth()-1, 1); renderCalendar() })
    nextMonth.addEventListener('click', ()=>{ calDate = new Date(calDate.getFullYear(), calDate.getMonth()+1, 1); renderCalendar() })
    selectToday.addEventListener('click', ()=>{ const t = new Date(); selectedDate = t.toISOString().slice(0,10); dateIn.value = selectedDate; repeatIn.value='once'; calDate = new Date(); renderCalendar(); render('selected') })
    clearDate.addEventListener('click', ()=>{ selectedDate = null; dateIn.value = ''; repeatIn.value='daily'; renderCalendar(); render('all') })

    // initial render
    renderCalendar()
    render()
  </script>
</body>
</html>
